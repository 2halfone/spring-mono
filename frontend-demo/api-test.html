<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Suite - Spring Auth System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 2rem;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 1rem;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #333;
            border-radius: 5px;
            background: #0d1117;
        }

        .test-section h3 {
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .test-button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }

        .test-button:hover {
            background: #00cc00;
        }

        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .result {
            background: #111;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #00ff00;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .result.error {
            border-left-color: #ff0000;
            color: #ff6666;
        }

        .result.success {
            border-left-color: #00ff00;
            color: #66ff66;
        }

        .credentials {
            background: #2d1b69;
            color: #fff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }

        .status-online {
            color: #00ff00;
        }

        .status-offline {
            color: #ff0000;
        }

        .loading {
            color: #ffff00;
        }

        .clear-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            cursor: pointer;
            border-radius: 3px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî¨ API TEST SUITE</h1>
        <p>Spring Boot Microservices Authentication System</p>
        <p>Complete endpoint testing interface</p>
    </div>

    <div class="test-container">
        <!-- Service Status -->
        <div class="test-section">
            <h3>üè• SERVICE HEALTH CHECK</h3>
            <button class="test-button" onclick="checkAllServices()">Check All Services</button>
            <button class="clear-btn" onclick="clearResults('serviceResults')">Clear</button>
            <div id="serviceResults" class="result"></div>
        </div>

        <!-- Authentication -->
        <div class="test-section">
            <h3>üîê AUTHENTICATION TESTS</h3>
            <div class="credentials">
                <strong>Test Credentials:</strong><br>
                Username: <code>admin</code> | Password: <code>admin123</code><br>
                Username: <code>user</code> | Password: <code>user123</code><br>
                Username: <code>test</code> | Password: <code>test123</code>
            </div>
            <button class="test-button" onclick="testLogin()">Test Login</button>
            <button class="test-button" onclick="testProfile()">Get Profile</button>
            <button class="test-button" onclick="testValidateToken()">Validate Token</button>
            <button class="test-button" onclick="testLogout()">Logout</button>
            <button class="clear-btn" onclick="clearResults('authResults')">Clear</button>
            <div id="authResults" class="result"></div>
        </div>        <!-- API Testing Section - Future Implementation -->
        <div class="test-section">
            <h3>üöÄ FUTURE API TESTS</h3>
            <p class="info">Future microservices API endpoints will be tested here.</p>
            <button class="test-button" disabled>Coming Soon - API Endpoints</button>
            <div id="futureResults" class="result"></div>
        </div>

        <!-- Registration -->
        <div class="test-section">
            <h3>üìù REGISTRATION TESTS</h3>
            <button class="test-button" onclick="testRegistration()">Test Registration</button>
            <button class="test-button" onclick="testUsernameCheck()">Check Username</button>
            <button class="test-button" onclick="testEmailCheck()">Check Email</button>
            <button class="clear-btn" onclick="clearResults('registrationResults')">Clear</button>
            <div id="registrationResults" class="result"></div>
        </div>

        <!-- Security Tests -->
        <div class="test-section">
            <h3>üõ°Ô∏è SECURITY TESTS</h3>
            <button class="test-button" onclick="testUnauthorizedAccess()">Test Unauthorized</button>
            <button class="test-button" onclick="testTokenExpiry()">Test Invalid Token</button>
            <button class="test-button" onclick="testAdminEndpoints()">Test Admin Access</button>
            <button class="clear-btn" onclick="clearResults('securityResults')">Clear</button>
            <div id="securityResults" class="result"></div>
        </div>

        <!-- Performance Tests -->
        <div class="test-section">
            <h3>‚ö° PERFORMANCE TESTS</h3>
            <button class="test-button" onclick="testResponseTimes()">Response Times</button>
            <button class="test-button" onclick="testConcurrentRequests()">Concurrent Requests</button>
            <button class="test-button" onclick="testLoadTest()">Load Test (10 requests)</button>
            <button class="clear-btn" onclick="clearResults('performanceResults')">Clear</button>
            <div id="performanceResults" class="result"></div>
        </div>

        <!-- Full System Test -->
        <div class="test-section">
            <h3>üöÄ COMPLETE SYSTEM TEST</h3>
            <button class="test-button" onclick="runFullSystemTest()" style="background: #ffd700; color: #000;">RUN ALL TESTS</button>
            <button class="clear-btn" onclick="clearAllResults()">Clear All</button>
            <div id="fullTestResults" class="result"></div>
        </div>
    </div>

    <script src="auth-client.js"></script>
    <script>
        // Global variables
        let testToken = null;
        let testResults = [];

        // Utility functions
        function log(message, containerId, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            container.textContent += logEntry;
            container.className = `result ${type}`;
            container.scrollTop = container.scrollHeight;
        }

        function clearResults(containerId) {
            document.getElementById(containerId).textContent = '';
        }

        function clearAllResults() {
            const resultElements = document.querySelectorAll('.result');
            resultElements.forEach(el => el.textContent = '');
        }

        // Service Health Checks
        async function checkAllServices() {
            log('üè• Checking all services...', 'serviceResults');
            
            const services = [
                { name: 'Auth Service', url: 'http://localhost:9081/actuator/health' },
                { name: 'Chat Service', url: 'http://localhost:9082/actuator/health' },
                { name: 'Gateway', url: 'http://localhost:9080/actuator/health' }
            ];

            for (const service of services) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(service.url);
                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ ${service.name}: ONLINE (${responseTime}ms) - Status: ${data.status}`, 'serviceResults', 'success');
                    } else {
                        log(`‚ùå ${service.name}: OFFLINE - HTTP ${response.status}`, 'serviceResults', 'error');
                    }
                } catch (error) {
                    log(`‚ùå ${service.name}: UNREACHABLE - ${error.message}`, 'serviceResults', 'error');
                }
            }
        }

        // Authentication Tests
        async function testLogin() {
            log('üîê Testing login...', 'authResults');
            
            try {
                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };

                const startTime = performance.now();
                const result = await springAuthClient.login(loginData.username, loginData.password);
                const endTime = performance.now();
                
                testToken = result.token;
                log(`‚úÖ Login successful! Token received (${Math.round(endTime - startTime)}ms)`, 'authResults', 'success');
                log(`   User: ${result.user.username} | Roles: ${result.user.roles?.join(', ') || 'USER'}`, 'authResults', 'success');
                log(`   Token: ${testToken.substring(0, 50)}...`, 'authResults', 'success');
            } catch (error) {
                log(`‚ùå Login failed: ${error.message}`, 'authResults', 'error');
            }
        }

        async function testProfile() {
            if (!testToken) {
                log('‚ö†Ô∏è No token available. Please login first.', 'authResults', 'error');
                return;
            }

            log('üë§ Testing profile endpoint...', 'authResults');
            
            try {
                const startTime = performance.now();
                const profile = await springAuthClient.getProfile();
                const endTime = performance.now();
                
                log(`‚úÖ Profile retrieved (${Math.round(endTime - startTime)}ms)`, 'authResults', 'success');
                log(`   Username: ${profile.username}`, 'authResults', 'success');
                log(`   Email: ${profile.email || 'Not set'}`, 'authResults', 'success');
                log(`   ID: ${profile.id}`, 'authResults', 'success');
                log(`   Roles: ${profile.roles?.join(', ') || 'USER'}`, 'authResults', 'success');
            } catch (error) {
                log(`‚ùå Profile request failed: ${error.message}`, 'authResults', 'error');
            }
        }

        async function testValidateToken() {
            if (!testToken) {
                log('‚ö†Ô∏è No token available. Please login first.', 'authResults', 'error');
                return;
            }

            log('üé´ Testing token validation...', 'authResults');
            
            try {
                const startTime = performance.now();
                const result = await springAuthClient.validateToken();
                const endTime = performance.now();
                
                log(`‚úÖ Token validation (${Math.round(endTime - startTime)}ms)`, 'authResults', 'success');
                log(`   Valid: ${result.valid}`, 'authResults', 'success');
                log(`   Username: ${result.username || 'N/A'}`, 'authResults', 'success');
            } catch (error) {
                log(`‚ùå Token validation failed: ${error.message}`, 'authResults', 'error');
            }
        }

        function testLogout() {
            log('üö™ Testing logout...', 'authResults');
            springAuthClient.logout();
            testToken = null;
            log('‚úÖ Logout completed. Token cleared.', 'authResults', 'success');
        }        // Future API Testing Functions
        // Movie API functions removed - endpoints not implemented
        // Future microservices will have their test functions here
        
        // Registration Tests
        async function testRegistration() {
            log('üìù Testing user registration...', 'registrationResults');
            
            try {
                const timestamp = Date.now();
                const testUser = {
                    username: `testuser${timestamp}`,
                    email: `test${timestamp}@example.com`,
                    password: 'testpass123',
                    firstName: 'Test',
                    lastName: 'User'
                };

                const startTime = performance.now();
                const result = await springAuthClient.register(testUser);
                const endTime = performance.now();
                
                log(`‚úÖ User registered (${Math.round(endTime - startTime)}ms)`, 'registrationResults', 'success');
                log(`   Username: ${testUser.username}`, 'registrationResults', 'success');
                log(`   Email: ${testUser.email}`, 'registrationResults', 'success');
            } catch (error) {
                log(`‚ùå Registration failed: ${error.message}`, 'registrationResults', 'error');
            }
        }

        async function testUsernameCheck() {
            log('üë§ Testing username availability...', 'registrationResults');
            
            try {
                // Test existing username
                const existingResult = await springAuthClient.checkUsername('admin');
                log(`‚úÖ Username 'admin' check: ${existingResult.available ? 'Available' : 'Taken'}`, 'registrationResults', 'success');
                
                // Test new username
                const newUsername = `newuser${Date.now()}`;
                const newResult = await springAuthClient.checkUsername(newUsername);
                log(`‚úÖ Username '${newUsername}' check: ${newResult.available ? 'Available' : 'Taken'}`, 'registrationResults', 'success');
            } catch (error) {
                log(`‚ùå Username check failed: ${error.message}`, 'registrationResults', 'error');
            }
        }

        async function testEmailCheck() {
            log('üìß Testing email availability...', 'registrationResults');
            
            try {
                // Test new email
                const newEmail = `test${Date.now()}@example.com`;
                const result = await springAuthClient.checkEmail(newEmail);
                log(`‚úÖ Email '${newEmail}' check: ${result.available ? 'Available' : 'Taken'}`, 'registrationResults', 'success');
            } catch (error) {
                log(`‚ùå Email check failed: ${error.message}`, 'registrationResults', 'error');
            }
        }

        // Security Tests
        async function testUnauthorizedAccess() {
            log('üõ°Ô∏è Testing unauthorized access...', 'securityResults');
            
            try {
                const response = await fetch('http://localhost:9081/auth/me');
                if (response.status === 401) {
                    log('‚úÖ Unauthorized access properly blocked (401)', 'securityResults', 'success');
                } else {
                    log(`‚ùå Unexpected response: ${response.status}`, 'securityResults', 'error');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'securityResults', 'error');
            }
        }

        async function testTokenExpiry() {
            log('üé´ Testing invalid token handling...', 'securityResults');
            
            try {
                const invalidToken = 'invalid.token.here';
                const response = await fetch('http://localhost:9081/auth/me', {
                    headers: { 'Authorization': `Bearer ${invalidToken}` }
                });
                
                if (response.status === 401) {
                    log('‚úÖ Invalid token properly rejected (401)', 'securityResults', 'success');
                } else {
                    log(`‚ùå Unexpected response: ${response.status}`, 'securityResults', 'error');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'securityResults', 'error');
            }
        }

        async function testAdminEndpoints() {
            if (!testToken) {
                log('‚ö†Ô∏è No token available. Please login first.', 'securityResults', 'error');
                return;
            }

            log('üëë Testing admin endpoint access...', 'securityResults');
            
            try {
                // This is a placeholder - replace with actual admin endpoint
                const response = await fetch('http://localhost:9081/admin/users', {
                    headers: { 'Authorization': `Bearer ${testToken}` }
                });
                
                log(`Admin endpoint response: ${response.status}`, 'securityResults', 
                     response.status === 403 ? 'success' : 'error');
            } catch (error) {
                log(`‚ùå Admin test failed: ${error.message}`, 'securityResults', 'error');
            }
        }

        // Performance Tests
        async function testResponseTimes() {
            log('‚ö° Testing response times...', 'performanceResults');
            
            const endpoints = [
                { name: 'Health Check', url: 'http://localhost:9081/actuator/health' },
                { name: 'Login', url: 'http://localhost:9081/auth/login', method: 'POST', body: { username: 'admin', password: 'admin123' } }
            ];

            for (const endpoint of endpoints) {
                try {
                    const startTime = performance.now();
                    
                    const options = {
                        method: endpoint.method || 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    };
                    
                    if (endpoint.body) {
                        options.body = JSON.stringify(endpoint.body);
                    }
                    
                    const response = await fetch(endpoint.url, options);
                    const endTime = performance.now();
                    const responseTime = Math.round(endTime - startTime);
                    
                    log(`‚úÖ ${endpoint.name}: ${responseTime}ms`, 'performanceResults', 'success');
                } catch (error) {
                    log(`‚ùå ${endpoint.name}: Failed`, 'performanceResults', 'error');
                }
            }
        }

        async function testConcurrentRequests() {
            log('üîÑ Testing concurrent requests...', 'performanceResults');
            
            const promises = [];
            const requestCount = 5;
            
            for (let i = 0; i < requestCount; i++) {
                promises.push(fetch('http://localhost:9081/actuator/health'));
            }
            
            try {
                const startTime = performance.now();
                const results = await Promise.all(promises);
                const endTime = performance.now();
                
                const successCount = results.filter(r => r.ok).length;
                const totalTime = Math.round(endTime - startTime);
                
                log(`‚úÖ ${successCount}/${requestCount} concurrent requests successful in ${totalTime}ms`, 'performanceResults', 'success');
            } catch (error) {
                log(`‚ùå Concurrent test failed: ${error.message}`, 'performanceResults', 'error');
            }
        }

        async function testLoadTest() {
            log('üöÄ Running load test (10 requests)...', 'performanceResults');
            
            const promises = [];
            const requestCount = 10;
            
            for (let i = 0; i < requestCount; i++) {
                promises.push(
                    fetch('http://localhost:9081/actuator/health')
                        .then(response => ({
                            success: response.ok,
                            status: response.status,
                            time: performance.now()
                        }))
                );
            }
            
            try {
                const startTime = performance.now();
                const results = await Promise.all(promises);
                const endTime = performance.now();
                
                const successCount = results.filter(r => r.success).length;
                const totalTime = Math.round(endTime - startTime);
                const avgTime = Math.round(totalTime / requestCount);
                
                log(`‚úÖ Load test completed: ${successCount}/${requestCount} successful`, 'performanceResults', 'success');
                log(`   Total time: ${totalTime}ms | Average: ${avgTime}ms`, 'performanceResults', 'success');
            } catch (error) {
                log(`‚ùå Load test failed: ${error.message}`, 'performanceResults', 'error');
            }
        }

        // Full System Test
        async function runFullSystemTest() {
            log('üöÄ Starting complete system test...', 'fullTestResults');
            
            const tests = [
                { name: 'Service Health', func: checkAllServices },
                { name: 'Login', func: testLogin },
                { name: 'Profile', func: testProfile },
                { name: 'Token Validation', func: testValidateToken },
                { name: 'Security', func: testUnauthorizedAccess },
                { name: 'Performance', func: testResponseTimes }
            ];
            
            let passedTests = 0;
            const startTime = performance.now();
            
            for (const test of tests) {
                try {
                    log(`üß™ Running ${test.name}...`, 'fullTestResults');
                    await test.func();
                    passedTests++;
                    log(`‚úÖ ${test.name} completed`, 'fullTestResults', 'success');
                } catch (error) {
                    log(`‚ùå ${test.name} failed: ${error.message}`, 'fullTestResults', 'error');
                }
            }
            
            const endTime = performance.now();
            const totalTime = Math.round(endTime - startTime);
            
            log(`\nüèÅ FULL SYSTEM TEST COMPLETE`, 'fullTestResults', 'success');
            log(`   Tests passed: ${passedTests}/${tests.length}`, 'fullTestResults', 'success');
            log(`   Total time: ${totalTime}ms`, 'fullTestResults', 'success');
            log(`   Success rate: ${Math.round((passedTests / tests.length) * 100)}%`, 'fullTestResults', 'success');
            
            if (passedTests === tests.length) {
                log(`\nüéâ ALL TESTS PASSED! System is fully functional.`, 'fullTestResults', 'success');
            } else {
                log(`\n‚ö†Ô∏è Some tests failed. Check individual results above.`, 'fullTestResults', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üî¨ API Test Suite initialized. Ready for testing!', 'fullTestResults');
            log('üí° Tip: Start with "Check All Services" to verify backend is running.', 'fullTestResults');
        });
    </script>
</body>
</html>
